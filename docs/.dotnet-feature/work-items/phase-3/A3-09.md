# A3-09: Implement AuthController (REST Endpoints)

> **Summary:** Implement REST authentication endpoints matching the TypeScript server including login, refresh, user info, and token verification.

[← Back to Phase 3](README.md) | [Phase Document](../PHASE-3-AUTH.md)

---

**Priority:** P0  
**Estimate:** 6 hours  
**Dependencies:** A3-01, A3-02, A3-08

## Description

Implement REST authentication endpoints matching the TypeScript server.

## Endpoints

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| POST | `/auth/login` | User login, returns tokens | No |
| POST | `/auth/refresh` | Refresh access token | Bearer (refresh token) |
| GET | `/auth/me` | Get current user info | Bearer |
| POST | `/auth/verify` | Verify token validity | No |

## Tasks

1. Create `AuthController.cs`
2. Implement `/auth/login` endpoint
3. Implement `/auth/refresh` endpoint
4. Implement `/auth/me` endpoint
5. Implement `/auth/verify` endpoint
6. Create request/response DTOs

## Acceptance Criteria

- [x] `/auth/login` returns valid token pair
- [x] `/auth/refresh` generates new access token
- [x] `/auth/me` returns user info from token
- [x] `/auth/verify` validates tokens correctly
- [x] Error responses match TypeScript server format

---

**Status:** ✅ Complete

## Implementation Notes

### Files Created

- `SyncKit.Server/Controllers/Auth/AuthController.cs` - REST controller with 4 endpoints
- `SyncKit.Server/Controllers/Auth/AuthDtos.cs` - Request/response DTOs
- `SyncKit.Server.Tests/Controllers/AuthControllerTests.cs` - 16 unit tests (all passing)
- `test-auth-endpoints.sh` - Integration test script for manual validation

### Testing

**Unit Tests:**
```bash
cd server/csharp/src
dotnet test --filter "FullyQualifiedName~AuthControllerTests"
```

**Integration Tests:**
```bash
# Start the server
cd server/csharp/src/SyncKit.Server
dotnet run

# In another terminal, run the integration tests
cd server/csharp
./test-auth-endpoints.sh
```

### Example Usage

**Login:**
```bash
curl -X POST http://localhost:8080/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123",
    "permissions": {
      "canRead": ["doc-1"],
      "canWrite": ["doc-1"],
      "isAdmin": false
    }
  }'
```

**Get User Info:**
```bash
curl -X GET http://localhost:8080/auth/me \
  -H "Authorization: Bearer <access_token>"
```

**Refresh Token:**
```bash
curl -X POST http://localhost:8080/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refreshToken": "<refresh_token>"}'
```

**Verify Token:**
```bash
curl -X POST http://localhost:8080/auth/verify \
  -H "Content-Type: application/json" \
  -d '{"token": "<token>"}'
```

### Implementation Details

The implementation matches the TypeScript server behavior:

1. **Token Generation**: Uses HS256 JWT tokens with configurable expiry (24h access, 7d refresh)
2. **Permission Structure**: Supports document-level permissions (canRead, canWrite, isAdmin)
3. **Demo Auth**: Like the TypeScript server, this accepts any email/password for demo purposes
4. **Error Handling**: Returns consistent error responses matching the TypeScript format
5. **Bearer Token Support**: /auth/me endpoint accepts tokens with or without "Bearer " prefix

### Integration with Existing Services

- Uses `IJwtGenerator` (A3-08) for token generation
- Uses `IJwtValidator` (A3-01) for token validation
- Registered via `AddControllers()` in Program.cs
- Routes automatically mapped via `MapControllers()`

