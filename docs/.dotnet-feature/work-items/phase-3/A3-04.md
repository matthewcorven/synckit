# A3-04: Implement Document Permission Checking

> **Summary:** Create RBAC helper methods to check if authenticated users can read/write specific documents, matching the TypeScript server's simple document-level permission model.

[← Back to Phase 3](README.md) | [Phase Document](../PHASE-3-AUTH.md)

---

**Priority:** P0  
**Estimate:** 1 hour  
**Dependencies:** A3-03 (TokenPayload with DocumentPermissions already exists)

## Description

Create simple permission-checking helper methods that match the TypeScript reference server's RBAC implementation. The TypeScript server uses a straightforward document-level permission model without wildcards or pattern matching.

## Reference Implementation

**TypeScript File:** `server/typescript/src/auth/rbac.ts`

The TypeScript server permission model:

| Property | Type | Description |
|----------|------|-------------|
| `canRead` | `string[]` | Array of document IDs user can read |
| `canWrite` | `string[]` | Array of document IDs user can write |
| `isAdmin` | `boolean` | Admins bypass all permission checks |

**Key Functions to Port:**
- `canReadDocument(payload, documentId)` → returns `true` if admin OR documentId in canRead array
- `canWriteDocument(payload, documentId)` → returns `true` if admin OR documentId in canWrite array

## Implementation Checklist

### Step 1: Create the RBAC file
- [x] Create file `server/csharp/src/SyncKit.Server/Auth/Rbac.cs`
- [x] Add namespace `SyncKit.Server.Auth`
- [x] Add `using` statement for any needed dependencies

### Step 2: Implement `CanReadDocument` method
- [x] Create static method `CanReadDocument(TokenPayload payload, string documentId)`
- [x] Return `true` if `payload.Permissions.IsAdmin` is `true`
- [x] Return `true` if `payload.Permissions.CanRead` contains `documentId`
- [x] Return `false` otherwise
- [x] Handle null checks for payload and permissions

### Step 3: Implement `CanWriteDocument` method
- [x] Create static method `CanWriteDocument(TokenPayload payload, string documentId)`
- [x] Return `true` if `payload.Permissions.IsAdmin` is `true`
- [x] Return `true` if `payload.Permissions.CanWrite` contains `documentId`
- [x] Return `false` otherwise
- [x] Handle null checks for payload and permissions

### Step 4: Implement helper methods (optional, for parity)
- [x] Create `IsAdmin(TokenPayload payload)` method
- [x] Create `GetPermissionLevel(TokenPayload payload, string documentId)` returning enum

### Step 5: Create PermissionLevel enum
- [x] Create `PermissionLevel` enum with values: `None`, `Read`, `Write`, `Admin`
- [x] Place in same file or separate `PermissionLevel.cs`

### Step 6: Add XML documentation
- [x] Add `<summary>` comments to all public methods
- [x] Add `<param>` comments for parameters
- [x] Add `<returns>` comments for return values

## Expected File Structure

```csharp
// server/csharp/src/SyncKit.Server/Auth/Rbac.cs
namespace SyncKit.Server.Auth;

public enum PermissionLevel
{
    None,
    Read,
    Write,
    Admin
}

public static class Rbac
{
    public static bool CanReadDocument(TokenPayload payload, string documentId) { ... }
    public static bool CanWriteDocument(TokenPayload payload, string documentId) { ... }
    public static bool IsAdmin(TokenPayload payload) { ... }
    public static PermissionLevel GetPermissionLevel(TokenPayload payload, string documentId) { ... }
}
```

## Acceptance Criteria

- [x] `Rbac.cs` file exists in `Auth/` directory
- [x] `CanReadDocument` returns `true` for admin users regardless of documentId
- [x] `CanReadDocument` returns `true` when documentId is in CanRead array
- [x] `CanReadDocument` returns `false` when documentId is NOT in CanRead array (non-admin)
- [x] `CanWriteDocument` returns `true` for admin users regardless of documentId
- [x] `CanWriteDocument` returns `true` when documentId is in CanWrite array
- [x] `CanWriteDocument` returns `false` when documentId is NOT in CanWrite array (non-admin)
- [x] Methods handle null payload gracefully (return `false`)
- [x] Methods handle null permissions gracefully (return `false`)
- [x] All public methods have XML documentation
- [x] Code compiles with `dotnet build`

## Unit Test Checklist

Create `server/csharp/src/SyncKit.Server.Tests/Auth/RbacTests.cs`:

- [x] Test: Admin can read any document
- [x] Test: Admin can write any document
- [x] Test: User with canRead permission can read that document
- [x] Test: User without canRead permission cannot read document
- [x] Test: User with canWrite permission can write that document
- [x] Test: User without canWrite permission cannot write document
- [x] Test: Null payload returns false
- [x] Test: Null permissions returns false
- [x] Test: GetPermissionLevel returns Admin for admin users
- [x] Test: GetPermissionLevel returns Write when user has write access
- [x] Test: GetPermissionLevel returns Read when user has only read access
- [x] Test: GetPermissionLevel returns None when user has no access

### Additional Edge Case Tests (Comprehensive Coverage)

- [x] Test: Null documentId returns false
- [x] Test: Empty/whitespace documentId returns false
- [x] Test: IsAdmin method works correctly
- [x] Test: Case sensitivity (document IDs are case-sensitive)
- [x] Test: Multiple documents in permission arrays
- [x] Test: GetPermissionLevel with null documentId

---

**Status:** ✅ Complete (23 tests, all passing)
