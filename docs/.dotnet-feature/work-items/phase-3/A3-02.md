# A3-02: Create API Key Validator Service

> **Summary:** Create a service to validate API keys as an alternative authentication method with full permissions granted.

[← Back to Phase 3](README.md) | [Phase Document](../PHASE-3-AUTH.md)

---

**Priority:** P0  
**Estimate:** 3 hours  
**Dependencies:** F1-02 (Configuration system)

## Description

Create a service to validate API keys as an alternative authentication method. API keys provide a simpler authentication mechanism compared to JWT tokens, typically used for:
- Server-to-server communication
- Testing and development
- Administrative access

When a valid API key is provided, the service returns a synthetic `TokenPayload` with full permissions, allowing unrestricted access to all operations.

## Tasks

1. Create `IApiKeyValidator.cs` interface in `Auth/` directory
2. Create `ApiKeyValidator.cs` implementation
3. Support multiple valid keys from configuration
4. Return synthetic `TokenPayload` for authorized keys with full permissions
5. Register service in DI container

## Configuration

API keys are configured via environment variable or `appsettings.json`:

```json
{
  "SyncKit": {
    "Auth": {
      "ApiKeys": ["sk_dev_abc123", "sk_prod_xyz789"]
    }
  }
}
```

Or via environment variable (comma-separated):
```bash
SYNCKIT_AUTH_APIKEYS="sk_dev_abc123,sk_prod_xyz789"
```

## Interface

```csharp
// SyncKit.Server/Auth/IApiKeyValidator.cs
namespace SyncKit.Server.Auth;

/// <summary>
/// Validates API keys as an alternative to JWT authentication.
/// </summary>
public interface IApiKeyValidator
{
    /// <summary>
    /// Validates an API key and returns a synthetic TokenPayload if valid.
    /// </summary>
    /// <param name="apiKey">The API key to validate</param>
    /// <returns>TokenPayload with full permissions if valid, null otherwise</returns>
    TokenPayload? Validate(string apiKey);
}
```

## Implementation

```csharp
// SyncKit.Server/Auth/ApiKeyValidator.cs
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;

namespace SyncKit.Server.Auth;

public class ApiKeyValidator : IApiKeyValidator
{
    private readonly HashSet<string> _validKeys;
    private readonly ILogger<ApiKeyValidator> _logger;

    public ApiKeyValidator(IOptions<SyncKitConfig> config, ILogger<ApiKeyValidator> logger)
    {
        _logger = logger;
        
        // Load API keys from configuration
        var apiKeys = config.Value.Auth?.ApiKeys ?? Array.Empty<string>();
        _validKeys = new HashSet<string>(
            apiKeys.Where(k => !string.IsNullOrWhiteSpace(k)),
            StringComparer.Ordinal  // Case-sensitive comparison
        );
        
        _logger.LogInformation("Loaded {Count} API keys", _validKeys.Count);
    }

    public TokenPayload? Validate(string apiKey)
    {
        if (string.IsNullOrWhiteSpace(apiKey))
        {
            _logger.LogDebug("API key validation failed: empty key");
            return null;
        }

        if (!_validKeys.Contains(apiKey))
        {
            _logger.LogWarning("API key validation failed: invalid key");
            return null;
        }

        _logger.LogDebug("API key validated successfully");
        
        // Return synthetic payload with full permissions
        return new TokenPayload
        {
            Sub = "api-key-user",
            ClientId = $"api-key-{apiKey[..Math.Min(8, apiKey.Length)]}",
            Iss = "synckit-api-key",
            Aud = "synckit",
            Exp = DateTimeOffset.UtcNow.AddYears(100).ToUnixTimeSeconds(),  // Effectively never expires
            Iat = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
            Permissions = new[]
            {
                "document:*",      // Full document access (read + write)
                "awareness:read",  // Awareness read access
                "awareness:write"  // Awareness write access
            }
        };
    }
}
```

## TokenPayload Reference

The `TokenPayload` class is defined in A3-01 and shared across auth validators:

```csharp
public class TokenPayload
{
    public string Sub { get; set; } = null!;    // User ID
    public string ClientId { get; set; } = null!;
    public string Iss { get; set; } = null!;     // Issuer
    public string Aud { get; set; } = null!;     // Audience
    public long Exp { get; set; }                // Expiration (Unix timestamp)
    public long Iat { get; set; }                // Issued at (Unix timestamp)
    public string[] Permissions { get; set; } = Array.Empty<string>();
}
```

## Service Registration

Add to `Program.cs` or service configuration:

```csharp
// Register API key validator
services.AddSingleton<IApiKeyValidator, ApiKeyValidator>();
```

## Usage in Auth Handler

The `AuthMessageHandler` (A3-03) will use this service:

```csharp
// In AuthMessageHandler.HandleAsync()
if (!string.IsNullOrEmpty(authMessage.ApiKey))
{
    var payload = _apiKeyValidator.Validate(authMessage.ApiKey);
    if (payload != null)
    {
        connection.Authenticate(payload);
        await connection.SendAsync(new AuthSuccessMessage { UserId = payload.Sub });
        return;
    }
}
```

## Acceptance Criteria

- [x] Valid API keys return `TokenPayload` with full permissions
- [x] Invalid API keys return `null`
- [x] Empty/whitespace API keys return `null`
- [x] Multiple API keys supported via configuration
- [x] API key comparison is case-sensitive
- [x] Full permissions granted: `IsAdmin = true` (grants full document access + awareness)
- [x] Service registered in DI container

## Test Cases

```csharp
public class ApiKeyValidatorTests
{
    [Fact]
    public void Validate_ValidKey_ReturnsPayloadWithFullPermissions()
    {
        var validator = CreateValidator("test-key-123");
        
        var result = validator.Validate("test-key-123");
        
        Assert.NotNull(result);
        Assert.Contains("document:*", result.Permissions);
        Assert.Contains("awareness:read", result.Permissions);
        Assert.Contains("awareness:write", result.Permissions);
    }

    [Fact]
    public void Validate_InvalidKey_ReturnsNull()
    {
        var validator = CreateValidator("valid-key");
        
        var result = validator.Validate("invalid-key");
        
        Assert.Null(result);
    }

    [Fact]
    public void Validate_EmptyKey_ReturnsNull()
    {
        var validator = CreateValidator("valid-key");
        
        var result = validator.Validate("");
        
        Assert.Null(result);
    }

    [Fact]
    public void Validate_MultipleKeys_AllValid()
    {
        var validator = CreateValidator("key1", "key2", "key3");
        
        Assert.NotNull(validator.Validate("key1"));
        Assert.NotNull(validator.Validate("key2"));
        Assert.NotNull(validator.Validate("key3"));
        Assert.Null(validator.Validate("key4"));
    }

    [Fact]
    public void Validate_CaseSensitive()
    {
        var validator = CreateValidator("MyApiKey");
        
        Assert.NotNull(validator.Validate("MyApiKey"));
        Assert.Null(validator.Validate("myapikey"));
        Assert.Null(validator.Validate("MYAPIKEY"));
    }

    private ApiKeyValidator CreateValidator(params string[] keys)
    {
        var config = Options.Create(new SyncKitConfig
        {
            Auth = new AuthConfig { ApiKeys = keys }
        });
        return new ApiKeyValidator(config, NullLogger<ApiKeyValidator>.Instance);
    }
}
```

---

**Status:** ✅ Completed

## Implementation Notes

The implementation follows the existing `TokenPayload` structure from A3-01, using `DocumentPermissions` with `IsAdmin = true` to grant full permissions. This aligns with the TypeScript server's permission model where admin users have unrestricted access to all documents and awareness features.

### Key Implementation Details:

1. **Interface & Implementation**: Created `IApiKeyValidator` and `ApiKeyValidator` in the `Auth/` directory
2. **Configuration**: Added `ApiKeys` property to `SyncKitConfig` with support for both:
   - `appsettings.json`: `"ApiKeys": ["key1", "key2"]`
   - Environment variable: `SYNCKIT_AUTH_APIKEYS="key1,key2"`
3. **DI Registration**: Service registered as singleton in `AuthExtensions.AddSyncKitAuth()`
4. **Test Coverage**: 12 unit tests covering all acceptance criteria + 4 configuration tests

### Test Results:
- ✅ 196 total tests passing
- ✅ 12 ApiKeyValidator unit tests
- ✅ 4 configuration tests for ApiKeys
- ✅ All acceptance criteria validated
