# T6-08: Redis-backed Awareness Store

> **Summary:** Implement an `IAwarenessStore` backed by Redis to store ephemeral awareness state across instances with TTL/expiration and efficient subscription/cleanup semantics.

---

**Priority:** P0  
**Estimate:** 4 hours  
**Dependencies:** W5-02 (IAwarenessStore + InMemory reference), T6-04 (Redis pub/sub)

## Description

Provide a Redis-backed implementation of the `IAwarenessStore` interface so awareness state can be shared across multiple server instances. The store should:

- Use Redis as the authoritative backing store for awareness entries (per-document, per-client).
- Support clock-based update ordering: stale updates are rejected (return false from `SetAsync`).
- Use TTLs to automatically expire entries; support `PruneExpiredAsync`/`GetExpiredAsync` as per interface.
- Support connection-scoped cleanup (`RemoveAllForConnectionAsync`).
- Be registered via DI when `Awareness:Provider=redis` (factory wiring in T6-05 should wire to this method once implemented).

## Key design decisions

- Key layout: `synckit:awareness:{documentId}` using a Redis HASH or sorted set per doc, and per-entry TTL via `PEXPIRE` or auxiliary key.
- Store serialized `AwarenessEntry` with clock and connection id metadata.
- TTL semantics: entries should expire automatically if not refreshed, but `PruneExpiredAsync` will also be implemented to backfill expirations and return stale entries for testing.
- Make `IConnectionMultiplexer` injectable to allow test injection/mocking for unit tests.

## Acceptance Criteria

- [ ] `RedisAwarenessStore` implements `IAwarenessStore` and is unit-tested.
- [ ] `SetAsync` enforces clock ordering and returns `false` for stale updates.
- [ ] Expiration works (entries drop after TTL) and `PruneExpiredAsync` returns expired items reliably in tests.
- [ ] `RemoveAllForConnectionAsync` removes all entries tied to a connection ID.
- [ ] Integration tests using Testcontainers/Docker validate correctness against a real Redis instance.
- [ ] DI registration helper `AddRedisAwarenessStorage(IConfigurationSection)` added, and `AddSyncKitStorage` supports `Awareness:Provider=redis`.

## Tests

- Unit tests for clock ordering, serialization, and behavior with a mocked `IConnectionMultiplexer`.
- Integration test using a Redis fixture to validate TTL expiration, pruning, and cross-instance visibility of awareness entries.

---

**Notes / Implementation tips:**

- Prefer `HSET` per-document with field per-client and auxiliary TTL (or use Redis streams/Sorted Sets depending on desired semantics).
- Be careful with concurrency and atomic updates (use Lua scripts or `WATCH`/`MULTI` if necessary).
- Provide a small adapter to make `IConnectionMultiplexer` creation injectable so CI tests don't create real connections during service registration.
