# T6-02: Create PostgreSQL Document Store

> **Summary:** Implement document storage with PostgreSQL using Npgsql, including documents table, deltas table, vector clocks, snapshots, and compaction.

[← Back to Phase 6](README.md) | [Phase Document](../PHASE-6-STORAGE.md)

---

**Priority:** P0  
**Estimate:** 8 hours  
**Dependencies:** T6-01

## Description

Implement document storage with PostgreSQL using Npgsql.

## Database Schema

```sql
-- migrations/001_initial_schema.sql
CREATE TABLE IF NOT EXISTS documents (
    id VARCHAR(255) PRIMARY KEY,
    vector_clock JSONB NOT NULL DEFAULT '{}',
    snapshot BYTEA,
    snapshot_clock JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS deltas (
    id VARCHAR(255) PRIMARY KEY,
    document_id VARCHAR(255) NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
    client_id VARCHAR(255) NOT NULL,
    data JSONB NOT NULL,
    vector_clock JSONB NOT NULL,
    timestamp BIGINT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_deltas_document_id ON deltas(document_id);
CREATE INDEX idx_deltas_timestamp ON deltas(document_id, timestamp);
```

## Key Operations

| Operation | Description |
|-----------|-------------|
| `GetOrCreateAsync` | Creates document if not exists |
| `AddDeltaAsync` | Inserts delta and updates vector clock |
| `GetDeltasSinceAsync` | Returns deltas newer than given clock |
| `SaveSnapshotAsync` | Persists snapshot for compaction |
| `CompactDeltasAsync` | Removes deltas included in snapshot |

## Acceptance Criteria

- [ ] Documents stored in PostgreSQL
- [ ] Deltas stored with vector clocks
- [ ] Snapshot storage works
- [ ] Compaction removes old deltas
- [ ] Connection pooling used
- [ ] Transactions for consistency

---

**Status:** ⬜ Not Started
