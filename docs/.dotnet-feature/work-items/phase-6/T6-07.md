# T6-07: Storage Integration Tests

> **Summary:** Integration tests for storage providers using Docker Compose or Testcontainers, covering PostgreSQL CRUD, migrations, and Redis pub/sub messaging.

[← Back to Phase 6](README.md) | [Phase Document](../PHASE-6-STORAGE.md)

---

**Priority:** P0  
**Estimate:** 6 hours  
**Dependencies:** T6-02 through T6-06

## Description

Integration tests for storage providers. Tests can run against:
1. **Aspire orchestration** (recommended for local development)
2. **Docker Compose services** (recommended for CI/CD)
3. **Testcontainers** (for isolated unit-style integration tests)

## Prerequisites

### Option 1: Aspire Orchestration (Recommended)

```bash
cd orchestration/aspire
dotnet run --project SyncKit.AppHost --launch-profile "C# Backend + PostgreSQL"

# PostgreSQL: localhost:5432
# Redis: localhost:6379
# View services in Aspire Dashboard: https://localhost:17235
```

### Option 2: Docker Compose

```bash
cd server/csharp
docker compose -f docker-compose.test.yml up -d postgres redis
```

## Test Categories

### PostgreSQL Document Store Tests

- GetOrCreateAsync creates in database
- AddDeltaAsync persists delta
- GetDeltasSinceAsync filters correctly
- SaveSnapshotAsync persists snapshot
- CompactDeltasAsync removes old deltas

### Redis Pub/Sub Tests

- PublishDeltaAsync delivers to subscribers
- PublishAwarenessAsync delivers to subscribers
- SubscribeAsync/UnsubscribeAsync manage channels
- Multi-instance message delivery

### Migration Tests

- RunMigrationsAsync applies new migrations
- Already-applied migrations are skipped
- Failed migrations roll back

## Example Test

```csharp
[Fact]
public async Task GetOrCreateAsync_NewDocument_CreatesInDatabase()
{
    var doc = await _store.GetOrCreateAsync("test-doc-1");
    
    Assert.NotNull(doc);
    Assert.Equal("test-doc-1", doc.Id);
    
    // Verify in database
    var fetched = await _store.GetAsync("test-doc-1");
    Assert.NotNull(fetched);
}
```

## Acceptance Criteria

- [ ] Tests run against Docker Compose services (primary)
- [ ] Testcontainers available as alternative
- [ ] All CRUD operations tested
- [ ] Migration execution tested
- [ ] Pub/sub messaging tested
- [ ] Tests isolated and repeatable
- [ ] CI/CD uses `docker-compose.test.yml`

---

**Status:** ⬜ Not Started
