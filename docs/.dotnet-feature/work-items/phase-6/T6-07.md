# T6-07: Storage Integration Tests

> **Summary:** Integration tests for storage providers using Docker Compose or Testcontainers, covering PostgreSQL CRUD, migrations, and Redis pub/sub messaging.

[← Back to Phase 6](README.md) | [Phase Document](../PHASE-6-STORAGE.md)

---

**Priority:** P0  
**Estimate:** 6 hours  
**Dependencies:** T6-02 through T6-06

## Description

Integration tests for storage providers. Tests can run against:
1. **Aspire orchestration** (recommended for local development)
2. **Docker Compose services** (recommended for CI/CD)
3. **Testcontainers** (for isolated unit-style integration tests)

## Prerequisites

### Option 1: Aspire Orchestration (Recommended)

```bash
cd orchestration/aspire
dotnet run --project SyncKit.AppHost --launch-profile "C# Backend + PostgreSQL"

# PostgreSQL: localhost:5432
# Redis: localhost:6379
# View services in Aspire Dashboard: https://localhost:17235
```

### Option 2: Docker Compose

```bash
cd server/csharp
docker compose -f docker-compose.test.yml up -d postgres redis
```

## Test Categories

### PostgreSQL Document Store Tests

- GetOrCreateAsync creates in database
- AddDeltaAsync persists delta
- GetDeltasSinceAsync filters correctly
- SaveSnapshotAsync persists snapshot
- CompactDeltasAsync removes old deltas

### Redis Pub/Sub Tests

- PublishDeltaAsync delivers to subscribers
- PublishAwarenessAsync delivers to subscribers
- SubscribeAsync/UnsubscribeAsync manage channels
- Multi-instance message delivery

### Migration Tests

- RunMigrationsAsync applies new migrations
- Already-applied migrations are skipped
- Failed migrations roll back

## Example Test

```csharp
[Fact]
public async Task GetOrCreateAsync_NewDocument_CreatesInDatabase()
{
    var doc = await _store.GetOrCreateAsync("test-doc-1");
    
    Assert.NotNull(doc);
    Assert.Equal("test-doc-1", doc.Id);
    
    // Verify in database
    var fetched = await _store.GetAsync("test-doc-1");
    Assert.NotNull(fetched);
}
```

## Acceptance Criteria

- [x] Tests run against Docker Compose services (primary) (C# tests use docker compose in CI)
- [x] Testcontainers available as alternative (added TypeScript integration tests using Testcontainers)
- [x] All CRUD operations tested (covered by C# `PostgresStorageAdapterTests`)
- [x] Migration execution tested (added TypeScript integration tests for `runMigration` covering apply, idempotency, and rollback)
- [x] Pub/sub messaging tested (covered by C# `RedisPubSubIntegrationTests`)
- [x] Tests isolated and repeatable (tests create temporary DB instances and temp migration dirs / use schema setup)
- [x] CI/CD uses `docker-compose.test.yml` (GitHub Actions workflow added at `.github/workflows/integration-tests.yml` and runs Postgres + Redis via `server/typescript/docker-compose.yml`)

---

**Status:** ✅ Completed — C# Postgres/Redis integration tests exist; TypeScript migration integration tests added; GitHub Actions workflow runs both TS and C# integration tests using Docker Compose
