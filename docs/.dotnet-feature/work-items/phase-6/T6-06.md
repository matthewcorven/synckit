# T6-06: Add Health Checks for Storage

> **Summary:** Add health check endpoints for PostgreSQL and Redis to enable Kubernetes readiness probes and operational monitoring.

[← Back to Phase 6](README.md) | [Phase Document](../PHASE-6-STORAGE.md)

---

**Priority:** P1  
**Estimate:** 2 hours  
**Dependencies:** T6-02, T6-04

## Prerequisites

When running under Aspire, health checks are automatically configured via ServiceDefaults:

```bash
cd orchestration/aspire
dotnet run --project SyncKit.AppHost --launch-profile "C# Backend + PostgreSQL"

# Health endpoints available at:
# - /health (overall)
# - /alive (liveness)
# View all services in Aspire Dashboard: https://localhost:17235
```

The Aspire Dashboard provides real-time health monitoring for all services including PostgreSQL and Redis.

## Description

Add health check endpoints for PostgreSQL and Redis.

## Health Check Implementations

```csharp
// PostgreSQL
public class PostgreSqlHealthCheck : IHealthCheck
{
    public async Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context,
        CancellationToken ct = default)
    {
        await using var conn = await _dataSource.OpenConnectionAsync(ct);
        await using var cmd = conn.CreateCommand();
        cmd.CommandText = "SELECT 1";
        await cmd.ExecuteScalarAsync(ct);
        return HealthCheckResult.Healthy("PostgreSQL connection successful");
    }
}

// Redis
public class RedisHealthCheck : IHealthCheck
{
    public async Task<HealthCheckResult> CheckHealthAsync(...)
    {
        var db = _redis.GetDatabase();
        var latency = await db.PingAsync();
        return HealthCheckResult.Healthy($"Redis connected, latency: {latency.TotalMilliseconds}ms");
    }
}
```

## Registration

```csharp
builder.Services.AddHealthChecks()
    .AddCheck<PostgreSqlHealthCheck>("postgresql", tags: new[] { "db", "ready" })
    .AddCheck<RedisHealthCheck>("redis", tags: new[] { "cache", "ready" });
```

## Endpoint Response

```bash
curl http://localhost:8080/health/ready
# {"status":"Healthy","results":{"postgresql":{"status":"Healthy"},"redis":{"status":"Healthy"}}}
```

## Acceptance Criteria

- [ ] PostgreSQL health check works
- [ ] Redis health check works
- [ ] Health checks tagged appropriately
- [ ] Latency reported for Redis

---

**Status:** ⬜ Not Started
