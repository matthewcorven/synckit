# T6-05: Create Storage Provider Factory

> **Summary:** Create factory to instantiate correct storage providers (in-memory or PostgreSQL) and optional Redis pub/sub based on configuration. Aligned with TypeScript server patterns.

[← Back to Phase 6](README.md) | [Phase Document](../PHASE-6-STORAGE.md)

---

**Priority:** P0  
**Estimate:** 3 hours  
**Dependencies:** T6-02, T6-04

## Description

Create factory to instantiate correct storage providers based on configuration. Follows TypeScript server's approach where:
- Document storage can be in-memory or PostgreSQL
- Awareness storage can be in-memory, Redis, or PostgreSQL (separate from document storage)
- Redis pub/sub is optional for multi-instance coordination

## TypeScript Reference

See `server/typescript/src/sync/coordinator.ts` constructor:
```typescript
constructor(options?: {
  storage?: StorageAdapter;
  pubsub?: RedisPubSub;
  serverId?: string;
}) {
  this.storage = options?.storage;
  this.pubsub = options?.pubsub;
  // ...
}
```

## Configuration

```json
{
  "Storage": {
    "Provider": "postgresql",  // "inmemory" | "postgresql"
    "PostgreSql": {
      "ConnectionString": "Host=localhost;Database=synckit;..."
    }
  },
  "Awareness": {
    "Provider": "inmemory",    // "inmemory" | "redis" | "postgresql"
    "Redis": {
      "ConnectionString": "localhost:6379"
    }
  },
  "PubSub": {
    "Enabled": true,
    "Provider": "redis",       // "redis" (only option for now)
    "Redis": {
      "ConnectionString": "localhost:6379",
      "ChannelPrefix": "synckit:"
    }
  }
}
```

## Extension Method

```csharp
public static IServiceCollection AddSyncKitStorage(
    this IServiceCollection services,
    IConfiguration configuration)
{
    var storageConfig = configuration.GetSection("Storage");
    var awarenessConfig = configuration.GetSection("Awareness");
    var pubsubConfig = configuration.GetSection("PubSub");
    
    // Storage adapter (matches TS StorageAdapter)
    var storageProvider = storageConfig.GetValue<string>("Provider") ?? "inmemory";
    switch (storageProvider.ToLowerInvariant())
    {
        case "postgresql":
        case "postgres":
            services.AddPostgreSqlStorage(storageConfig);
            break;
        case "inmemory":
        default:
            services.AddSingleton<IStorageAdapter, InMemoryStorageAdapter>();
            break;
    }

    // Awareness storage (separate from document storage)
    var awarenessProvider = awarenessConfig.GetValue<string>("Provider") ?? "inmemory";
    switch (awarenessProvider.ToLowerInvariant())
    {
        case "redis":
            services.AddRedisAwarenessStorage(awarenessConfig);
            break;
        case "postgresql":
        case "postgres":
            services.AddPostgreSqlAwarenessStorage(awarenessConfig);
            break;
        case "inmemory":
        default:
            services.AddSingleton<IAwarenessStore, InMemoryAwarenessStore>();
            break;
    }

    // Redis pub/sub for multi-instance coordination (optional)
    if (pubsubConfig.GetValue<bool>("Enabled"))
    {
        services.AddRedisPubSub(pubsubConfig);
    }

    return services;
}

private static void AddPostgreSqlStorage(
    this IServiceCollection services, 
    IConfigurationSection config)
{
    var connectionString = config.GetValue<string>("PostgreSql:ConnectionString")
        ?? throw new InvalidOperationException("PostgreSQL connection string required");

    services.AddNpgsqlDataSource(connectionString);
    services.AddSingleton<IMigrationRunner, MigrationRunner>();
    services.AddSingleton<IStorageAdapter, PostgresAdapter>();
}
```

## Acceptance Criteria

- [ ] In-memory storage works by default (`InMemoryStorageAdapter`)
- [ ] PostgreSQL storage configurable (`PostgresAdapter`)
- [ ] Awareness storage configurable separately (inmemory/redis/postgresql)
- [ ] Redis pub/sub optional for multi-instance
- [ ] Connection strings from config
- [ ] Factory validates configuration
- [ ] Interface named `IStorageAdapter` (matches TS `StorageAdapter`)

---

**Status:** ⬜ Not Started
