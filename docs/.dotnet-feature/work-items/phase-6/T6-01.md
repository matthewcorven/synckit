# T6-01: Define Storage Abstractions

> **Summary:** Define storage interfaces that support multiple implementations (in-memory, PostgreSQL) including document store, snapshot storage, and health checks.

[← Back to Phase 6](README.md) | [Phase Document](../PHASE-6-STORAGE.md)

---

**Priority:** P0  
**Estimate:** 2 hours  
**Dependencies:** S4-03

## Description

Ensure storage interfaces support multiple implementations (in-memory, PostgreSQL).

## Tasks

1. Review `IDocumentStore` interface
2. Add missing methods for persistence
3. Create `IStorageProvider` abstraction
4. Support async enumeration

## Updated Interfaces

```csharp
// SyncKit.Server/Storage/IStorageProvider.cs
public interface IStorageProvider
{
    IDocumentStore Documents { get; }
    IAwarenessStore Awareness { get; }
    Task InitializeAsync(CancellationToken ct = default);
    Task<HealthCheckResult> CheckHealthAsync(CancellationToken ct = default);
}

// SyncKit.Server/Sync/IDocumentStore.cs (updated)
public interface IDocumentStore
{
    Task<Document> GetOrCreateAsync(string documentId);
    Task<Document?> GetAsync(string documentId);
    Task<bool> ExistsAsync(string documentId);
    Task DeleteAsync(string documentId);
    Task<IReadOnlyList<string>> GetDocumentIdsAsync(int limit = 1000, string? cursor = null);
    Task AddDeltaAsync(string documentId, StoredDelta delta);
    Task<IReadOnlyList<StoredDelta>> GetDeltasSinceAsync(string documentId, VectorClock? since);
    Task<VectorClock> GetVectorClockAsync(string documentId);
    
    // New: for persistence
    Task SaveSnapshotAsync(string documentId, byte[] snapshot, VectorClock clock);
    Task<(byte[]? Snapshot, VectorClock Clock)?> GetSnapshotAsync(string documentId);
    Task CompactDeltasAsync(string documentId, VectorClock upToClock);
}
```

## Acceptance Criteria

- [ ] IStorageProvider defined
- [ ] IDocumentStore supports snapshots
- [ ] Compaction interface defined
- [ ] Health check supported

---

**Status:** ⬜ Not Started
