# T6-09: PostgreSQL-backed Awareness Store

> **Summary:** Implement an `IAwarenessStore` backed by PostgreSQL to persist awareness state (optional persistent store) with pruning, TTL-like semantics, and SQL-based query efficiency.

---

**Priority:** P0  
**Estimate:** 6â€“8 hours  
**Dependencies:** W5-02 (IAwarenessStore), T6-02 (PostgreSQL adapter), T6-03 (migrations)

## Description

Provide a PostgreSQL-backed implementation of `IAwarenessStore` for environments that prefer SQL-backed awareness (e.g., when awareness state needs to survive service restarts or be inspected). The implementation should:

- Define a compact table for awareness entries with columns: document_id, client_id, connection_id, state (jsonb), clock_value, last_seen (timestamp).
- Implement `SetAsync` with clock-based ordering and transactional safety.
- Implement `PruneExpiredAsync` using SQL time comparisons and appropriate indexes.
- Provide efficient `GetAllAsync(documentId)` and `RemoveAllForConnectionAsync(connectionId)` operations.
- Include migration SQL and ensure `SchemaValidator` can validate required table presence (link with T6-03).

## Acceptance Criteria

- [ ] Database migration created and added to shared migration tooling (T6-03).
- [ ] `PostgresAwarenessStore` implements `IAwarenessStore` and is unit- and integration-tested.
- [ ] `SetAsync` enforces clock ordering and is transactionally safe under concurrent updates.
- [ ] `PruneExpiredAsync` deletes expired entries and `GetExpiredAsync` returns expired entries for sanity checks.
- [ ] DI registration helper `AddPostgreSqlAwarenessStorage(IConfigurationSection)` added, and `AddSyncKitStorage` supports `Awareness:Provider=postgresql`.
- [ ] Integration tests using Testcontainers/Postgres confirm behavior and performance sensitivity.

## Tests

- Unit tests for ordering, pruning logic, and removal behaviors.
- Integration tests that run migrations (T6-03), start Postgres container, and validate real-world behavior.

---

**Notes / Implementation tips:**

- Consider `last_seen` + `clock_value` indexes for prune and ordering queries.
- Column `state` should be `jsonb` to keep consistency with other JSON storage.
- Migrations are required and must be added to shared migration runner; test migrations in CI before enabling this provider by default.
