# V7-02: Run Binary Protocol Tests

> **Summary:** Run and pass all binary protocol tests validating wire format compatibility, endianness, type codes, and round-trip encoding against both TypeScript and C# server implementations.

[‚Üê Back to Phase 7](README.md) | [Phase Document](../PHASE-7-TESTING.md)

---

**Priority:** P0  
**Estimate:** 3 hours  
**Dependencies:** V7-01

## Description

Run and pass all binary protocol tests against both server implementations to validate protocol compatibility.

## Test Files

- `tests/binary/basic-sync.test.ts` - End-to-end binary sync tests
- `tests/binary/debug-encoding.test.ts` - Encoding/decoding validation
- `tests/binary/server-parsing.test.ts` - Server-side message parsing

## Expected Tests

| Test | Description |
|------|-------------|
| Binary message encoding | Correct header format |
| Binary message decoding | Parse header correctly |
| Type code mapping | All codes match |
| Endianness | Big-endian for multi-byte |
| Round-trip | Encode ‚Üí decode matches |
| Basic sync | Connect, auth, sync with binary protocol |
| Multi-client sync | Multiple clients syncing via binary |

## Validation Commands

### Against TypeScript Server (baseline)

```bash
cd tests
bun test binary/
```

### Against C# Server

```bash
cd tests
TEST_SERVER_TYPE=csharp bun test binary/
```

### Against External Server

```bash
cd tests
SYNCKIT_SERVER_URL=ws://localhost:8080/ws bun test binary/
```

## Troubleshooting Guide

| Issue | Likely Cause | Fix |
|-------|--------------|-----|
| Header parse fail | Endianness wrong | Use `BinaryPrimitives` with BigEndian |
| Wrong type code | Mapping mismatch | Check `MessageTypeCode` enum |
| Truncated message | Payload length wrong | Verify uint32 read |
| Auth timeout | Server not sending auth_success | Check `AuthMessageHandler` sends response |
| Connection timeout | Server URL mismatch | Verify `SYNCKIT_SERVER_URL` or `TEST_SERVER_TYPE` |
| State mismatch | Auto-auth not working | Check `ConnectionManager` auto-auth logic |

## C# Server Changes Required

The following changes were made to support binary protocol tests:

1. **`Program.cs`** - Added `SYNCKIT_SERVER_URL` environment variable support
2. **`ConnectionManager.cs`** - Added auto-authentication when `AuthRequired=false`
3. **`Connection.cs`** - Preserve `Authenticated` state during message processing
4. **`AuthMessageHandler.cs`** - Send `auth_success` for already-authenticated connections

## Acceptance Criteria

- [ ] All binary tests pass against TypeScript server (baseline)
- [ ] All binary tests pass against C# server
- [ ] Wire format matches between implementations
- [ ] No test timeouts
- [ ] Error cases handled identically

---

**Status:** üîÑ In Progress ‚Äî Test harness updated, auth flow fixed, encoding tests passing
