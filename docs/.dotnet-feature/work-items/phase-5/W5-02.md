# W5-02: Create Awareness Store

> **Summary:** Create in-memory store for awareness state with clock-based ordering, automatic expiration, and connection cleanup.

[← Back to Phase 5](README.md) | [Phase Document](../PHASE-5-AWARENESS.md)

---

**Priority:** P0  
**Estimate:** 4 hours  
**Dependencies:** W5-01

## Description

Create in-memory store for awareness state with automatic expiration.

## Configuration

| Parameter | Default | Description |
|-----------|---------|-------------|
| `AWARENESS_TIMEOUT_MS` | 30000 | Time before awareness expires |

## Interface

```csharp
// SyncKit.Server/Awareness/IAwarenessStore.cs
public interface IAwarenessStore
{
    Task<AwarenessEntry?> GetAsync(string documentId, string clientId);
    Task<IReadOnlyList<AwarenessEntry>> GetAllAsync(string documentId);
    /// <summary>
    /// Store or update an awareness entry. Returns true if the update was applied,
    /// false if rejected (e.g., stale clock).
    /// </summary>
    Task<bool> SetAsync(string documentId, string clientId, AwarenessState state, long clock);
    Task RemoveAsync(string documentId, string clientId);
    Task RemoveAllForConnectionAsync(string connectionId);
    Task<IReadOnlyList<AwarenessEntry>> GetExpiredAsync();
    Task PruneExpiredAsync();
}
```

## Key Behaviors

- State stored per document per client
- Clock-based update ordering (stale updates rejected)
- Expiration tracked for cleanup
- Connection cleanup removes all entries for that connection

## Acceptance Criteria

- [x] State stored per document per client
- [x] Clock-based update ordering
- [x] Stale updates rejected
- [x] Expiration tracked
- [x] Pruning removes expired entries
- [x] Connection cleanup removes all entries

---

**Status:** ✅ Completed

**Notes:** Implemented `IAwarenessStore` and `InMemoryAwarenessStore` with:
- Clock-based update rejection (SetAsync returns false for stale updates)
- Expiration using `SyncKitConfig.AwarenessTimeoutMs` (default 30000ms)
- Pruning (`PruneExpiredAsync`) and `GetExpiredAsync`
- `RemoveAllForConnectionAsync` for connection cleanup

Also registered the store in DI and wired `AwarenessUpdateMessageHandler` to persist updates to the store (Phase 5 W5-03 will add broadcasting to subscribers).
