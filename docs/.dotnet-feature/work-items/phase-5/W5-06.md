# W5-06: Add Awareness Expiration Timer

> **Summary:** Add background service to periodically prune expired awareness entries and notify subscribers of stale clients going offline.

[← Back to Phase 5](README.md) | [Phase Document](../PHASE-5-AWARENESS.md)

---

**Priority:** P1  
**Estimate:** 2 hours  
**Dependencies:** W5-02

## Description

Add background timer to prune expired awareness entries and notify subscribers.

## Implementation

```csharp
// SyncKit.Server/Awareness/AwarenessCleanupService.cs
public class AwarenessCleanupService : BackgroundService
{
    private readonly TimeSpan _interval = TimeSpan.FromSeconds(10);
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            await Task.Delay(_interval, stoppingToken);
            
            // Get expired entries before pruning
            var expired = await _awarenessStore.GetExpiredAsync();
            
            // Notify subscribers of each expired entry
            foreach (var entry in expired)
            {
                await _connectionManager.BroadcastToDocumentAsync(
                    entry.DocumentId,
                    new AwarenessUpdateMessage
                    {
                        DocumentId = entry.DocumentId,
                        ClientId = entry.ClientId,
                        State = null, // null = offline
                        Clock = entry.Clock + 1
                    });
            }
            
            await _awarenessStore.PruneExpiredAsync();
        }
    }
}
```

## Registration

```csharp
// Program.cs
builder.Services.AddHostedService<AwarenessCleanupService>();
```

## Acceptance Criteria

- [x] Background service runs periodically
- [x] Expired entries pruned
- [x] Subscribers notified of expiration
- [x] Graceful shutdown

---

**Status:** ✅ Completed
