# W5-07: Awareness Unit Tests

> **Summary:** Comprehensive unit tests for awareness protocol including store operations, clock ordering, expiration, handlers, and cleanup services.

[← Back to Phase 5](README.md) | [Phase Document](../PHASE-5-AWARENESS.md)

---

**Priority:** P0  
**Estimate:** 4 hours  
**Dependencies:** W5-01 through W5-06

## Description

Comprehensive unit tests for awareness protocol.

## Test Categories

### 1. Awareness Store Tests

- SetAsync stores new entries
- SetAsync with older clock is ignored
- GetAllAsync excludes expired entries
- PruneExpiredAsync removes stale entries
- RemoveAllForConnectionAsync cleans up on disconnect

### 2. Handler Tests

- AwarenessUpdateHandler validates auth
- AwarenessUpdateHandler requires document subscription
- AwarenessUpdateHandler broadcasts to other subscribers
- AwarenessSubscribeHandler returns all active entries
- Sender excluded from broadcast

### 3. Cleanup Service Tests

- ExecuteAsync prunes expired entries periodically
- Subscribers notified of expiration
- Graceful shutdown stops service

## Example Tests

```csharp
[Fact]
public async Task SetAsync_OlderClock_Ignored()
{
    var store = CreateStore();
    var state1 = new AwarenessState { UserId = "user-1" };
    var state2 = new AwarenessState { UserId = "user-2" };
    
    await store.SetAsync("doc-1", "client-1", state1, 5);
    await store.SetAsync("doc-1", "client-1", state2, 3); // Older clock
    
    var entry = await store.GetAsync("doc-1", "client-1");
    Assert.Equal("user-1", entry!.State.UserId); // Still state1
}

[Fact]
public async Task HandleAsync_NotSubscribed_SendsError()
{
    var handler = CreateHandler();
    var connection = CreateAuthenticatedConnection();
    // Not subscribed to document
    
    var message = new AwarenessUpdateMessage
    {
        DocumentId = "doc-1",
        ClientId = "client-1",
        State = JsonDocument.Parse("{}").RootElement,
        Clock = 1
    };

    await handler.HandleAsync(connection, message);
    
    // Verify error sent
}
```

## Acceptance Criteria

- [ ] Store operations tested
- [ ] Clock ordering tested
- [ ] Expiration tested
- [ ] Handler logic tested
- [ ] Cleanup service tested
- [ ] Disconnect cleanup tested

---

**Status:** ⬜ Not Started
