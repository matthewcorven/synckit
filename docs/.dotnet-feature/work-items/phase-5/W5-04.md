# W5-04: Implement Awareness Subscribe Handler

> **Summary:** Handle AWARENESS_SUBSCRIBE to send current awareness state for all clients connected to a document.

[← Back to Phase 5](README.md) | [Phase Document](../PHASE-5-AWARENESS.md)

---

**Priority:** P0  
**Estimate:** 3 hours  
**Dependencies:** W5-02

## Description

Handle AWARENESS_SUBSCRIBE to send current awareness state for a document.

## Response Message

Returns AWARENESS_STATE with all active awareness entries for the document:

```json
{
  "type": "awareness_state",
  "id": "msg-1",
  "timestamp": 1234567890,
  "documentId": "doc-1",
  "states": [
    {
      "clientId": "clientA",
      "state": { "userId": "alice", "cursor": { "x": 100, "y": 200 } },
      "clock": 1
    }
  ]
}
```

## Acceptance Criteria

- [x] Auth required for awareness subscribe
- [x] Returns all active awareness for document
- [x] Expired entries not included
- [x] AWARENESS_STATE message format correct

---

**Status:** ✅ Done

**Implementation notes:**
- Added `AwarenessSubscribeMessageHandler` implementation to fetch active entries from `IAwarenessStore`, add connection subscription, and send `AwarenessStateMessage` (id set to request id).
- Added unit tests in `AwarenessSubscribeMessageHandlerTests` covering empty and populated responses and logging behavior.
- Updated related auth enforcement tests to instantiate the handler with a mock `IAwarenessStore`.

**Files changed:**
- `server/csharp/src/SyncKit.Server/WebSockets/Handlers/AwarenessSubscribeMessageHandler.cs`
- `server/csharp/src/SyncKit.Server.Tests/WebSockets/Handlers/AwarenessSubscribeMessageHandlerTests.cs`
- `server/csharp/src/SyncKit.Server.Tests/WebSockets/Handlers/MessageHandlerAuthEnforcementTests.cs`
