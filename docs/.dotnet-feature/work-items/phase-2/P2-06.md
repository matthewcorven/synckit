# P2-06: Implement Protocol Auto-Detection

> **Summary:** Implement automatic protocol detection based on the first message, matching the TypeScript behavior (JSON starts with `{`, binary starts with type code).

[← Back to Phase 2](README.md) | [Phase Document](../PHASE-2-PROTOCOL.md)

---

**Priority:** P0  
**Estimate:** 3 hours  
**Dependencies:** P2-04, P2-05

## Description

Implement automatic protocol detection based on the first message, matching the TypeScript behavior.

## Tasks

1. Update Connection.DetectProtocol()
2. Add detection logging
3. Add detection tests
4. Document detection algorithm

## Detection Algorithm

```csharp
private void DetectProtocol(ReadOnlySpan<byte> data)
{
    if (Protocol != ProtocolType.Unknown) return;
    
    // JSON starts with '{' (0x7B) possibly preceded by whitespace
    // Binary starts with type code (0x01-0x42 or 0xFF)
    
    if (data.Length == 0)
    {
        Protocol = ProtocolType.Binary; // Default to binary
        return;
    }

    var firstByte = data[0];
    
    // Check for JSON indicators
    if (firstByte == 0x7B || // '{'
        firstByte == 0x5B || // '['
        firstByte == 0x20 || // space
        firstByte == 0x09 || // tab
        firstByte == 0x0A || // newline
        firstByte == 0x0D)   // carriage return
    {
        Protocol = ProtocolType.Json;
    }
    else
    {
        Protocol = ProtocolType.Binary;
    }
    
    _logger.LogDebug(
        "Connection {ConnectionId} protocol detected: {Protocol} (first byte: 0x{FirstByte:X2})",
        Id, Protocol, firstByte);
}
```

## Detection Rules

| First Byte | Protocol Detected |
|------------|-------------------|
| `0x7B` (`{`) | JSON |
| `0x5B` (`[`) | JSON |
| `0x20` (space) | JSON |
| `0x09` (tab) | JSON |
| `0x0A` (newline) | JSON |
| `0x0D` (CR) | JSON |
| Any other | Binary |

## Acceptance Criteria

- [ ] JSON detected when message starts with `{`
- [ ] Binary detected for all other first bytes
- [ ] Detection happens only once per connection
- [ ] Detection logged for debugging
- [ ] Same detection logic as TypeScript

---

**Status:** ⬜ Not Started
