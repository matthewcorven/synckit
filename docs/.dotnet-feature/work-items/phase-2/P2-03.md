# P2-03: Define Message Types

> **Summary:** Define all message types and codes exactly matching the TypeScript implementation for full protocol compatibility.

[← Back to Phase 2](README.md) | [Phase Document](../PHASE-2-PROTOCOL.md)

---

**Priority:** P0  
**Estimate:** 3 hours  
**Dependencies:** None

## Description

Define all message types and codes exactly matching the TypeScript implementation.

## Tasks

1. Create `MessageType.cs` enum
2. Create `MessageTypeCode.cs` enum
3. Create base `IMessage` interface
4. Create message DTOs for each type
5. Add JSON serialization attributes

## Message Type Enum

```csharp
// SyncKit.Server/WebSocket/Protocol/MessageType.cs
public enum MessageType
{
    Connect,
    Disconnect,
    Ping,
    Pong,
    Auth,
    AuthSuccess,
    AuthError,
    Subscribe,
    Unsubscribe,
    SyncRequest,
    SyncResponse,
    Delta,
    Ack,
    AwarenessUpdate,
    AwarenessSubscribe,
    AwarenessState,
    Error
}
```

## Message Type Codes (Binary Protocol)

```csharp
// SyncKit.Server/WebSocket/Protocol/MessageTypeCode.cs
public enum MessageTypeCode : byte
{
    AUTH = 0x01,
    AUTH_SUCCESS = 0x02,
    AUTH_ERROR = 0x03,
    SUBSCRIBE = 0x10,
    UNSUBSCRIBE = 0x11,
    SYNC_REQUEST = 0x12,
    SYNC_RESPONSE = 0x13,
    DELTA = 0x20,
    ACK = 0x21,
    PING = 0x30,
    PONG = 0x31,
    AWARENESS_UPDATE = 0x40,
    AWARENESS_SUBSCRIBE = 0x41,
    AWARENESS_STATE = 0x42,
    ERROR = 0xFF
}
```

## Base Interface

```csharp
public interface IMessage
{
    MessageType Type { get; }
    string Id { get; set; }
    long Timestamp { get; set; }
}
```

## All Message Types Required

| Type | Properties |
|------|------------|
| AuthMessage | Token?, ApiKey? |
| AuthSuccessMessage | UserId, Permissions |
| AuthErrorMessage | Error |
| SubscribeMessage | DocumentId |
| UnsubscribeMessage | DocumentId |
| SyncRequestMessage | DocumentId, VectorClock? |
| SyncResponseMessage | RequestId, DocumentId, State?, Deltas? |
| DeltaMessage | DocumentId, Delta, VectorClock |
| AckMessage | MessageId |
| PingMessage | (base only) |
| PongMessage | (base only) |
| AwarenessUpdateMessage | DocumentId, ClientId, State, Clock |
| AwarenessSubscribeMessage | DocumentId |
| AwarenessStateMessage | DocumentId, States[] |
| ErrorMessage | Error, Details? |

## Acceptance Criteria

- [x] All message types defined
- [x] Type codes match TypeScript exactly
- [x] JSON serialization works correctly
- [x] Messages have required properties

## Implementation Notes

All message types have been implemented in `WebSockets/Protocol/Messages/` directory:

- **MessageType.cs** - String-based enum for JSON protocol
- **MessageTypeCode.cs** - Byte-based enum for binary protocol
- **MessageTypeMapper.cs** - Conversion between MessageType and MessageTypeCode
- **BaseMessage.cs** - Abstract base class for all messages
- **Individual message classes** - 19 concrete message types:
  - ConnectMessage, PingMessage, PongMessage
  - AuthMessage, AuthSuccessMessage, AuthErrorMessage
  - SubscribeMessage, UnsubscribeMessage
  - SyncRequestMessage, SyncResponseMessage
  - DeltaMessage, AckMessage
  - AwarenessUpdateMessage, AwarenessSubscribeMessage, AwarenessStateMessage
  - ErrorMessage

All message types include proper JSON serialization attributes and match the TypeScript implementation exactly.

---

**Status:** ✅ Complete
