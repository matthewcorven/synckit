# P2-09: Protocol Unit Tests

> **Summary:** Comprehensive unit tests for both protocol handlers and auto-detection, ensuring full compatibility with the TypeScript implementation.

[← Back to Phase 2](README.md) | [Phase Document](../PHASE-2-PROTOCOL.md)

---

**Priority:** P0  
**Estimate:** 6 hours  
**Dependencies:** P2-04, P2-05

## Description

Comprehensive unit tests for both protocol handlers and auto-detection.

## Test Categories

1. JSON Protocol Tests
2. Binary Protocol Tests
3. Protocol Detection Tests
4. Round-trip Tests
5. Edge Case Tests

## Test Examples

```csharp
public class JsonProtocolHandlerTests
{
    private readonly JsonProtocolHandler _handler = new();

    [Fact]
    public void Parse_AuthMessage_Success()
    {
        var json = """{"type":"auth","id":"msg-1","timestamp":1234567890,"token":"jwt"}""";
        var bytes = Encoding.UTF8.GetBytes(json);
        
        var message = _handler.Parse(bytes);
        
        Assert.NotNull(message);
        Assert.IsType<AuthMessage>(message);
        Assert.Equal("jwt", ((AuthMessage)message).Token);
    }

    [Fact]
    public void Parse_InvalidJson_ReturnsNull()
    {
        var bytes = Encoding.UTF8.GetBytes("not json");
        var message = _handler.Parse(bytes);
        Assert.Null(message);
    }
}

public class BinaryProtocolHandlerTests
{
    private readonly BinaryProtocolHandler _handler = new();

    [Fact]
    public void Parse_ValidBinaryMessage_Success()
    {
        var payload = """{"id":"msg-1","token":"jwt"}""";
        var payloadBytes = Encoding.UTF8.GetBytes(payload);
        
        var buffer = new byte[13 + payloadBytes.Length];
        buffer[0] = 0x01; // AUTH type code
        BinaryPrimitives.WriteInt64BigEndian(buffer.AsSpan(1, 8), 1234567890);
        BinaryPrimitives.WriteUInt32BigEndian(buffer.AsSpan(9, 4), (uint)payloadBytes.Length);
        payloadBytes.CopyTo(buffer.AsSpan(13));

        var message = _handler.Parse(buffer);

        Assert.NotNull(message);
        Assert.Equal(MessageType.Auth, message.Type);
    }
}

public class ProtocolDetectionTests
{
    [Theory]
    [InlineData(0x7B, ProtocolType.Json)]  // '{'
    [InlineData(0x20, ProtocolType.Json)]  // space
    [InlineData(0x01, ProtocolType.Binary)] // AUTH code
    [InlineData(0x30, ProtocolType.Binary)] // PING code
    public void DetectProtocol_FirstByte_CorrectResult(byte firstByte, ProtocolType expected)
    {
        // Test protocol detection logic
    }
}
```

## Acceptance Criteria

- [x] All message types have parse tests
- [x] All message types have serialize tests
- [x] Round-trip tests pass for all types
- [x] Edge cases handled (empty, malformed, oversized)
- [x] Protocol detection tests pass
- [x] Binary endianness tested

---

**Status:** ✅ Complete
