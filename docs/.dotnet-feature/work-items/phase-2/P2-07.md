# P2-07: Implement Heartbeat (Ping/Pong)

> **Summary:** Implement WebSocket heartbeat mechanism to detect stale connections, with configurable intervals and automatic termination of unresponsive clients.

[← Back to Phase 2](README.md) | [Phase Document](../PHASE-2-PROTOCOL.md)

---

**Priority:** P0  
**Estimate:** 3 hours  
**Dependencies:** P2-02

## Description

Implement WebSocket heartbeat mechanism to detect stale connections.

## Configuration

| Parameter | Default | Description |
|-----------|---------|-------------|
| `WS_HEARTBEAT_INTERVAL` | 30000ms | Time between pings |
| `WS_HEARTBEAT_TIMEOUT` | 60000ms | Time to wait for pong |

## Tasks

1. Add heartbeat timer to Connection
2. Send PING messages at interval
3. Track last PONG received
4. Terminate stale connections
5. Handle client-initiated PING

## Implementation

```csharp
// In Connection class
private Timer? _heartbeatTimer;
private DateTime _lastPong;

public void StartHeartbeat(int intervalMs, int timeoutMs)
{
    _lastPong = DateTime.UtcNow;
    
    _heartbeatTimer = new Timer(async _ =>
    {
        // Check if connection is stale
        if ((DateTime.UtcNow - _lastPong).TotalMilliseconds > timeoutMs)
        {
            _logger.LogWarning(
                "Connection {ConnectionId} heartbeat timeout - terminating",
                Id);
            await CloseAsync(
                WebSocketCloseStatus.PolicyViolation, 
                "Heartbeat timeout");
            return;
        }

        // Send ping
        await SendAsync(new PingMessage
        {
            Id = MessageIdGenerator.Generate(),
            Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
        });
        
    }, null, intervalMs, intervalMs);
}

public void HandlePong()
{
    _lastPong = DateTime.UtcNow;
    MarkAlive();
}

public async Task HandlePingAsync(PingMessage ping)
{
    await SendAsync(new PongMessage
    {
        Id = MessageIdGenerator.Generate(),
        Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
    });
}
```

## Acceptance Criteria

- [ ] Server sends PING every 30s
- [ ] Server responds to client PING with PONG
- [ ] Connection terminated if no PONG within 60s
- [ ] Heartbeat interval/timeout configurable

---

**Status:** ⬜ Not Started
