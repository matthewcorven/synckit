# P2-04: Implement JSON Protocol Handler

> **Summary:** Implement JSON protocol handler for test suite compatibility, with camelCase property names and snake_case enum values.

[← Back to Phase 2](README.md) | [Phase Document](../PHASE-2-PROTOCOL.md)

---

**Priority:** P0  
**Estimate:** 4 hours  
**Dependencies:** P2-03

## Description

Implement JSON protocol handler for test suite compatibility. Must parse and serialize messages as JSON text.

## Tasks

1. Create `IProtocolHandler.cs` interface
2. Create `JsonProtocolHandler.cs`
3. Implement Parse method
4. Implement Serialize method
5. Configure System.Text.Json options
6. Add source generator context

## Interface

```csharp
public interface IProtocolHandler
{
    IMessage? Parse(ReadOnlyMemory<byte> data);
    ReadOnlyMemory<byte> Serialize(IMessage message);
}
```

## Implementation

```csharp
public class JsonProtocolHandler : IProtocolHandler
{
    private static readonly JsonSerializerOptions Options = new()
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        PropertyNameCaseInsensitive = true,
        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull,
        Converters = { new JsonStringEnumConverter(JsonNamingPolicy.SnakeCaseLower) }
    };

    public IMessage? Parse(ReadOnlyMemory<byte> data)
    {
        try
        {
            var json = Encoding.UTF8.GetString(data.Span);
            using var doc = JsonDocument.Parse(json);
            var root = doc.RootElement;
            
            if (!root.TryGetProperty("type", out var typeElement))
                return null;

            var typeStr = typeElement.GetString();
            if (!Enum.TryParse<MessageType>(typeStr, true, out var messageType))
                return null;

            return messageType switch
            {
                MessageType.Auth => JsonSerializer.Deserialize<AuthMessage>(json, Options),
                MessageType.Ping => JsonSerializer.Deserialize<PingMessage>(json, Options),
                // ... other types
                _ => null
            };
        }
        catch (JsonException)
        {
            return null;
        }
    }

    public ReadOnlyMemory<byte> Serialize(IMessage message)
    {
        var json = JsonSerializer.Serialize(message, message.GetType(), Options);
        return Encoding.UTF8.GetBytes(json);
    }
}
```

## JSON Format Examples

```json
// Auth request
{
  "type": "auth",
  "id": "msg-123",
  "timestamp": 1702900000000,
  "token": "jwt.token.here"
}

// Delta message
{
  "type": "delta",
  "id": "msg-456",
  "timestamp": 1702900001000,
  "documentId": "doc-1",
  "delta": { "field": "value" },
  "vectorClock": { "client-1": 5 }
}
```

## Acceptance Criteria

- [x] Parses all message types correctly
- [x] Serializes all message types correctly
- [x] Handles malformed JSON gracefully
- [x] camelCase property names
- [x] snake_case enum values

## Implementation Notes

### Files Created/Modified

1. **SnakeCaseNamingPolicy.cs** - Custom JSON naming policy for converting enum values to snake_case
2. **JsonProtocolHandler.cs** - Complete implementation with:
   - Parses all 17 message types from JSON
   - Serializes messages to JSON
   - Handles both snake_case and PascalCase type names for compatibility
   - Proper error handling for malformed JSON
   - Logging at trace and error levels

3. **JsonProtocolHandlerTests.cs** - Comprehensive test suite with 41 tests covering:
   - Parse tests for all message types
   - Serialize tests with proper formatting validation
   - Round-trip tests
   - Error handling tests
   - Property naming validation

### JSON Serialization Configuration

```csharp
PropertyNamingPolicy = JsonNamingPolicy.CamelCase  // Properties: camelCase
Converters = { new JsonStringEnumConverter(new SnakeCaseNamingPolicy()) }  // Enums: snake_case
PropertyNameCaseInsensitive = true  // Accept any case on input
DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull  // Omit null properties
```

### Test Results

✅ **All 46 tests passing** (21 JsonProtocolHandler + 5 Integration tests + 20 other tests)

**JsonProtocolHandlerTests.cs** - 21 tests:
- Parse tests for all message types (10 tests)
- Serialize tests with proper formatting (8 tests)
- Round-trip serialization tests (2 tests)
- Error handling tests (1 test)

**JsonProtocolIntegrationTests.cs** - 5 tests:
- TypeScript compatibility verification
- Snake_case enum validation
- CamelCase property validation
- Format matching tests

### Example Output

```json
// Serialized PingMessage
{"type":"ping","id":"ping-1","timestamp":1702900000000}

// Serialized AuthSuccessMessage  
{"type":"auth_success","id":"auth-1","timestamp":1702900000000,"userId":"user-123","permissions":{"read":true}}

// Serialized DeltaMessage
{"type":"delta","id":"delta-1","timestamp":1702900000000,"documentId":"doc-1","delta":{"field":"value"},"vectorClock":{"client-1":5}}
```

---

**Status:** ✅ Complete
