# P2-04: Implement JSON Protocol Handler

> **Summary:** Implement JSON protocol handler for test suite compatibility, with camelCase property names and snake_case enum values.

[← Back to Phase 2](README.md) | [Phase Document](../PHASE-2-PROTOCOL.md)

---

**Priority:** P0  
**Estimate:** 4 hours  
**Dependencies:** P2-03

## Description

Implement JSON protocol handler for test suite compatibility. Must parse and serialize messages as JSON text.

## Tasks

1. Create `IProtocolHandler.cs` interface
2. Create `JsonProtocolHandler.cs`
3. Implement Parse method
4. Implement Serialize method
5. Configure System.Text.Json options
6. Add source generator context

## Interface

```csharp
public interface IProtocolHandler
{
    IMessage? Parse(ReadOnlyMemory<byte> data);
    ReadOnlyMemory<byte> Serialize(IMessage message);
}
```

## Implementation

```csharp
public class JsonProtocolHandler : IProtocolHandler
{
    private static readonly JsonSerializerOptions Options = new()
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        PropertyNameCaseInsensitive = true,
        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull,
        Converters = { new JsonStringEnumConverter(JsonNamingPolicy.SnakeCaseLower) }
    };

    public IMessage? Parse(ReadOnlyMemory<byte> data)
    {
        try
        {
            var json = Encoding.UTF8.GetString(data.Span);
            using var doc = JsonDocument.Parse(json);
            var root = doc.RootElement;
            
            if (!root.TryGetProperty("type", out var typeElement))
                return null;

            var typeStr = typeElement.GetString();
            if (!Enum.TryParse<MessageType>(typeStr, true, out var messageType))
                return null;

            return messageType switch
            {
                MessageType.Auth => JsonSerializer.Deserialize<AuthMessage>(json, Options),
                MessageType.Ping => JsonSerializer.Deserialize<PingMessage>(json, Options),
                // ... other types
                _ => null
            };
        }
        catch (JsonException)
        {
            return null;
        }
    }

    public ReadOnlyMemory<byte> Serialize(IMessage message)
    {
        var json = JsonSerializer.Serialize(message, message.GetType(), Options);
        return Encoding.UTF8.GetBytes(json);
    }
}
```

## JSON Format Examples

```json
// Auth request
{
  "type": "auth",
  "id": "msg-123",
  "timestamp": 1702900000000,
  "token": "jwt.token.here"
}

// Delta message
{
  "type": "delta",
  "id": "msg-456",
  "timestamp": 1702900001000,
  "documentId": "doc-1",
  "delta": { "field": "value" },
  "vectorClock": { "client-1": 5 }
}
```

## Acceptance Criteria

- [ ] Parses all message types correctly
- [ ] Serializes all message types correctly
- [ ] Handles malformed JSON gracefully
- [ ] camelCase property names
- [ ] snake_case enum values

---

**Status:** ⬜ Not Started
