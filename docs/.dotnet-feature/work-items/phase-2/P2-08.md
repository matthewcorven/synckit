# P2-08: Add ConnectionManager

> **Summary:** Create a singleton service to manage all active WebSocket connections with thread-safe operations, including the unified disconnect flow for proper cleanup.

[← Back to Phase 2](README.md) | [Phase Document](../PHASE-2-PROTOCOL.md)

---

**Priority:** P0  
**Estimate:** 4 hours  
**Dependencies:** P2-02

## Description

Create a singleton service to manage all active WebSocket connections.

## Tasks

1. Create `IConnectionManager.cs` interface
2. Create `ConnectionManager.cs` implementation
3. Add connection tracking
4. Add connection lookup methods
5. Add broadcast capabilities
6. Thread-safe implementation

## Interface

```csharp
public interface IConnectionManager
{
    Task<Connection> CreateConnectionAsync(WebSocket webSocket);
    Connection? GetConnection(string connectionId);
    IReadOnlyList<Connection> GetAllConnections();
    IReadOnlyList<Connection> GetConnectionsByDocument(string documentId);
    IReadOnlyList<Connection> GetConnectionsByUser(string userId);
    Task RemoveConnectionAsync(string connectionId);
    Task BroadcastToDocumentAsync(string documentId, IMessage message, string? excludeConnectionId = null);
    Task CloseAllAsync(WebSocketCloseStatus status, string description);
    int ConnectionCount { get; }
}
```

## Unified Connection Disconnect Flow

When a connection closes (gracefully or abruptly), the following cleanup sequence **must** execute in order:

```
┌─────────────────────────────────────────────────────────────────┐
│                    CONNECTION DISCONNECT FLOW                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. STOP MESSAGE PROCESSING                                       │
│    • Cancel receive loop CancellationToken                       │
│    • Set State = Disconnecting                                   │
│    • Stop heartbeat timer                                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. UNSUBSCRIBE FROM ALL DOCUMENTS                                │
│    • Get list of subscribed document IDs                         │
│    • For each document:                                          │
│      - Remove connection from document subscribers               │
│      - coordinator.Unsubscribe(documentId, connectionId)         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. CLEAR AWARENESS STATE                                         │
│    • For each subscribed document:                               │
│      - Remove client from awareness store                        │
│      - Broadcast null state to other subscribers                 │
│    • awarenessStore.RemoveAllForConnectionAsync(connectionId)    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. NOTIFY OTHER CLIENTS                                          │
│    • For each previously-subscribed document:                    │
│      - Send AWARENESS_UPDATE with state: null                    │
│      - Other clients know this client went offline               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. DISPOSE RESOURCES                                             │
│    • Close WebSocket with appropriate close code:                │
│      - 1000 (Normal) for graceful disconnect                     │
│      - 1001 (Going Away) for server shutdown                     │
│      - 1008 (Policy Violation) for auth failure                  │
│    • Return ArrayPool buffer                                     │
│    • Dispose CancellationTokenSource                             │
│    • Remove from ConnectionManager registry                      │
│    • Set State = Disconnected                                    │
└─────────────────────────────────────────────────────────────────┘
```

## WebSocket Close Codes Reference

| Code | Name | When Used |
|------|------|-----------|
| 1000 | Normal Closure | Client/server graceful disconnect |
| 1001 | Going Away | Server shutdown |
| 1008 | Policy Violation | Auth failure, permission denied |
| 1011 | Internal Error | Unhandled server exception |
| 4001 | Auth Required | Custom: no auth message received |
| 4002 | Auth Failed | Custom: invalid token |
| 4003 | Permission Denied | Custom: RBAC rejection |

## Acceptance Criteria

- [ ] Connections tracked by ID
- [ ] Max connection limit enforced
- [ ] Lookup by document subscription works
- [ ] Lookup by user ID works
- [ ] Broadcast to document works
- [ ] Thread-safe operations
- [ ] RemoveConnectionAsync cleans up all subscriptions (document + awareness)
- [ ] CloseAllAsync closes all connections gracefully (for shutdown)

---

**Status:** ⬜ Not Started
