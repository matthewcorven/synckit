# P2-01: Create WebSocket Middleware

> **Summary:** Create ASP.NET Core middleware to handle WebSocket upgrade requests at `/ws` endpoint with proper connection lifecycle management.

[← Back to Phase 2](README.md) | [Phase Document](../PHASE-2-PROTOCOL.md)

---

**Priority:** P0  
**Estimate:** 6 hours  
**Dependencies:** F1-04

## Description

Create ASP.NET Core middleware to handle WebSocket upgrade requests at `/ws` endpoint.

## Tasks

1. Create `SyncWebSocketMiddleware.cs`
2. Configure WebSocket options (buffer sizes, keep-alive)
3. Handle upgrade requests
4. Integrate with ConnectionManager
5. Add request logging

## Implementation

```csharp
// SyncKit.Server/WebSocket/SyncWebSocketMiddleware.cs
public class SyncWebSocketMiddleware
{
    private readonly RequestDelegate _next;
    private readonly IConnectionManager _connectionManager;
    private readonly ILogger<SyncWebSocketMiddleware> _logger;

    public SyncWebSocketMiddleware(
        RequestDelegate next,
        IConnectionManager connectionManager,
        ILogger<SyncWebSocketMiddleware> logger)
    {
        _next = next;
        _connectionManager = connectionManager;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        if (context.Request.Path == "/ws")
        {
            if (context.WebSockets.IsWebSocketRequest)
            {
                var webSocket = await context.WebSockets.AcceptWebSocketAsync();
                var connection = await _connectionManager.CreateConnectionAsync(webSocket);
                
                _logger.LogInformation("WebSocket connection established: {ConnectionId}", 
                    connection.Id);
                
                try
                {
                    await connection.ProcessMessagesAsync();
                }
                catch (OperationCanceledException) when (context.RequestAborted.IsCancellationRequested)
                {
                    _logger.LogDebug("Client {ConnectionId} disconnected", connection.Id);
                }
                catch (WebSocketException ex) when (ex.WebSocketErrorCode == WebSocketError.ConnectionClosedPrematurely)
                {
                    _logger.LogDebug("Client {ConnectionId} closed connection", connection.Id);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Unhandled exception for connection {ConnectionId}", connection.Id);
                }
                finally
                {
                    await _connectionManager.RemoveConnectionAsync(connection.Id);
                }
            }
            else
            {
                context.Response.StatusCode = StatusCodes.Status400BadRequest;
            }
        }
        else
        {
            await _next(context);
        }
    }
}
```

## Registration

```csharp
// Program.cs
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddSingleton<IConnectionManager, ConnectionManager>();

var app = builder.Build();

app.UseWebSockets(new WebSocketOptions
{
    KeepAliveInterval = TimeSpan.FromSeconds(30)
});

app.UseMiddleware<SyncWebSocketMiddleware>();
```

## Acceptance Criteria

- [x] WebSocket upgrade at `/ws` succeeds
- [x] Non-WebSocket requests to `/ws` return 400
- [x] Connection ID logged on connect
- [x] WebSocket options configurable
- [x] Graceful handling of client disconnects (no error logs)
- [x] Unhandled exceptions logged but not exposed to client

---

**Status:** ✅ Complete
