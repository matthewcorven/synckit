# F1-02: Add Configuration System

> **Summary:** Implement configuration management using ASP.NET Core Configuration with environment variable support, matching the TypeScript server's configuration pattern.

[← Back to Phase 1](README.md) | [Phase Document](../PHASE-1-FOUNDATION.md)

---

**Priority:** P0  
**Estimate:** 4 hours  
**Dependencies:** F1-01

## Description

Implement configuration management using ASP.NET Core Configuration with environment variable support, matching the TypeScript server's configuration pattern.

## Tasks

1. Create `SyncKitConfig.cs` configuration class
2. Create `appsettings.json` with defaults
3. Create `appsettings.Development.json`
4. Add environment variable mapping
5. Register configuration in DI container
6. Add configuration validation

## Configuration Class

```csharp
// SyncKit.Server/Configuration/SyncKitConfig.cs
public class SyncKitConfig
{
    // Server
    public int Port { get; set; } = 8080;
    public string Host { get; set; } = "0.0.0.0";
    public string Environment { get; set; } = "Development";
    
    // Database
    public string? DatabaseUrl { get; set; }
    public int DatabasePoolMin { get; set; } = 2;
    public int DatabasePoolMax { get; set; } = 10;
    
    // Redis
    public string? RedisUrl { get; set; }
    public string RedisChannelPrefix { get; set; } = "synckit:";
    
    // JWT
    [Required, MinLength(32)]
    public string JwtSecret { get; set; } = null!;
    public string JwtExpiresIn { get; set; } = "24h";
    public string JwtRefreshExpiresIn { get; set; } = "7d";
    
    // WebSocket
    [Range(1, int.MaxValue)]
    public int WsHeartbeatInterval { get; set; } = 30000;
    public int WsHeartbeatTimeout { get; set; } = 60000;
    public int WsMaxConnections { get; set; } = 10000;
    
    // Sync
    public int SyncBatchSize { get; set; } = 100;
    public int SyncBatchDelay { get; set; } = 50;
    
    // Auth
    public bool AuthRequired { get; set; } = true;
}
```

## Environment Variable Mapping

| Environment Variable | Config Property | Default |
|---------------------|-----------------|---------|
| `PORT` | `Port` | `8080` |
| `HOST` | `Host` | `0.0.0.0` |
| `ASPNETCORE_ENVIRONMENT` | `Environment` | `Development` |
| `DATABASE_URL` | `DatabaseUrl` | - |
| `DB_POOL_MIN` | `DatabasePoolMin` | `2` |
| `DB_POOL_MAX` | `DatabasePoolMax` | `10` |
| `REDIS_URL` | `RedisUrl` | - |
| `REDIS_CHANNEL_PREFIX` | `RedisChannelPrefix` | `synckit:` |
| `JWT_SECRET` | `JwtSecret` | **Required** |
| `JWT_EXPIRES_IN` | `JwtExpiresIn` | `24h` |
| `JWT_REFRESH_EXPIRES_IN` | `JwtRefreshExpiresIn` | `7d` |
| `WS_HEARTBEAT_INTERVAL` | `WsHeartbeatInterval` | `30000` |
| `WS_HEARTBEAT_TIMEOUT` | `WsHeartbeatTimeout` | `60000` |
| `WS_MAX_CONNECTIONS` | `WsMaxConnections` | `10000` |
| `SYNC_BATCH_SIZE` | `SyncBatchSize` | `100` |
| `SYNC_BATCH_DELAY` | `SyncBatchDelay` | `50` |
| `SYNCKIT_AUTH_REQUIRED` | `AuthRequired` | `true` |

## Configuration Registration

```csharp
// Program.cs - Options pattern with validation (mirrors TypeScript Zod validation)
builder.Services.AddOptions<SyncKitConfig>()
    .Bind(builder.Configuration)
    .ValidateDataAnnotations()
    .ValidateOnStart(); // Fail fast on startup if config invalid
```

## Acceptance Criteria

- [x] Configuration loads from appsettings.json
- [x] Configuration loads from environment variables
- [x] Environment variables override appsettings
- [x] Configuration validation fails on startup if JWT_SECRET missing or <32 chars
- [x] Validation rules match TypeScript Zod schema
- [x] IOptions<SyncKitConfig> injectable via DI

---

**Status:** ✅ Complete
