# F1-09: Implement Graceful Shutdown

> **Summary:** Implement graceful shutdown handling using `IHostApplicationLifetime`, matching the TypeScript server's SIGTERM/SIGINT handlers with a 10-second force-exit timeout.

[← Back to Phase 1](README.md) | [Phase Document](../PHASE-1-FOUNDATION.md)

---

**Priority:** P1  
**Estimate:** 2 hours  
**Dependencies:** F1-02

## Description

Implement graceful shutdown handling using `IHostApplicationLifetime`, matching the TypeScript server's SIGTERM/SIGINT handlers.

> **Reference:** TypeScript server [index.ts](server/typescript/src/index.ts) implements shutdown with 10s force-exit timeout.

## Tasks

1. Register shutdown handlers via `IHostApplicationLifetime`
2. Stop accepting new connections
3. Close existing WebSocket connections gracefully
4. Dispose storage/Redis connections
5. Add force-exit timeout (10s)

## Implementation

```csharp
// Program.cs
var app = builder.Build();
var lifetime = app.Services.GetRequiredService<IHostApplicationLifetime>();

lifetime.ApplicationStopping.Register(async () =>
{
    Log.Information("Shutdown signal received, closing gracefully...");
    
    // 1. Stop accepting new WebSocket connections
    // (middleware will reject new upgrades)
    
    // 2. Close all active WebSocket connections
    var connectionManager = app.Services.GetRequiredService<IConnectionManager>();
    await connectionManager.CloseAllAsync(
        WebSocketCloseStatus.EndpointUnavailable, 
        "Server shutdown");
    
    // 3. Dispose coordinator (clears awareness, unsubscribes)
    var coordinator = app.Services.GetRequiredService<ISyncCoordinator>();
    await coordinator.DisposeAsync();
    
    Log.Information("Graceful shutdown complete");
});

// Force exit after 10 seconds (matches TypeScript)
lifetime.ApplicationStopping.Register(() =>
{
    Task.Delay(TimeSpan.FromSeconds(10)).ContinueWith(_ =>
    {
        Log.Warning("Forced shutdown after timeout");
        Environment.Exit(1);
    });
});
```

## Acceptance Criteria

- [ ] Server responds to SIGTERM gracefully
- [ ] Server responds to SIGINT (Ctrl+C) gracefully
- [ ] Active WebSocket connections closed with 1001 status
- [ ] Storage/Redis connections disposed
- [ ] Force exit after 10 seconds if shutdown hangs

---

**Status:** ⬜ Not Started
